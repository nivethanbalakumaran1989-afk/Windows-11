name: "‚ö° EnigMano ZeroTier ARM Deployment"

on:
  workflow_dispatch:
    inputs:
      ZEROTIER_NETWORK_ID:
        description: "Your 16-digit ZeroTier Network ID"
        required: true

jobs:
  deploy-arm-rdp:
    name: "üöÄ Deploy ARM RDP via ZeroTier"
    runs-on: windows-11-arm
    timeout-minutes: 360

    steps:
      - name: üîê Configure Local Credentials
        shell: pwsh
        run: |
          $User = "runneradmin"
          $Pass = "EnigMano2026!"
          
          # Check if the user already exists
          $UserExists = net user | Select-String -Pattern $User
          
          if ($UserExists) {
            Write-Host "‚ö†Ô∏è User $User already exists. Resetting password..."
            net user $User $Pass
          } else {
            Write-Host "üÜï Creating new user $User..."
            net user $User $Pass /add
          }
          
          # Ensure user is in administrators group (suppress error if already a member)
          net localgroup administrators $User /add 2>$null
          
          Write-Host "‚úÖ Account $User is ready for tactical deployment."

      - name: üèóÔ∏è Install ZeroTier
        shell: pwsh
        run: |
          $url = "https://download.zerotier.com/dist/ZeroTier%20One.msi"
          $outpath = "$env:TEMP\ZeroTier.msi"
          if (!(Test-Path $outpath)) {
            Invoke-WebRequest -Uri $url -OutFile $outpath
          }
          Start-Process msiexec.exe -ArgumentList "/i $outpath /quiet /qn /norestart" -Wait
          Write-Host "‚úÖ ZeroTier Installed"

      - name: üåê Connect to Virtual Network
        shell: pwsh
        run: |
          Start-Sleep -Seconds 15
          $networkId = "${{ github.event.inputs.ZEROTIER_NETWORK_ID }}"
          & "C:\Program Files (x86)\ZeroTier\One\zerotier-one_x64.exe" -q join $networkId
          Write-Host "üì° Network Join Request Sent. Go authorize it on your dashboard!"

      - name: üñ•Ô∏è Configure Remote Desktop (RDP)
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
          Write-Host "‚úÖ RDP Port Open."

      - name: ‚è≥ Maintenance Loop (Keep Alive)
        shell: pwsh
        run: |
          Write-Host "üöÄ RDP Session Started"
          for ($i=1; $i -le 360; $i++) {
            Write-Host "Heartbeat: Instance is online ($i/360 mins)"
            Start-Sleep -Seconds 60
          }
