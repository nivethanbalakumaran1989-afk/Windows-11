name: "âš¡ EnigMano ZeroTier ARM Deployment"

on:
  workflow_dispatch:
    inputs:
      ZEROTIER_NETWORK_ID:
        description: "Your 16-digit ZeroTier Network ID"
        required: true
        default: ""

jobs:
  deploy-arm-rdp:
    name: "ğŸš€ Deploy ARM RDP via ZeroTier"
    # Keeping your specific runner label
    runs-on: windows-11-arm
    timeout-minutes: 360

    steps:
      - name: ğŸ” Set Local Credentials
        shell: pwsh
        run: |
          $User = "runneradmin"
          $Pass = "EnigMano2026!"
          net user $User $Pass /add
          net localgroup administrators $User /add
          Write-Host "âœ… Account $User created with tactical precision."

      - name: ğŸ—ï¸ Install ZeroTier (ARM Emulation/Native)
        shell: pwsh
        run: |
          $url = "https://download.zerotier.com/dist/ZeroTier%20One.msi"
          $outpath = "$env:TEMP\ZeroTier.msi"
          Write-Host "ğŸ“¥ Downloading ZeroTier..."
          Invoke-WebRequest -Uri $url -OutFile $outpath
          Write-Host "âš™ï¸ Installing ZeroTier..."
          Start-Process msiexec.exe -ArgumentList "/i $outpath /quiet /qn /norestart" -Wait
          Write-Host "âœ… ZeroTier installation sequence complete."

      - name: ğŸŒ Connect to Virtual Network
        shell: pwsh
        run: |
          # Give the service a moment to initialize
          Start-Sleep -Seconds 15
          $networkId = "${{ github.event.inputs.ZEROTIER_NETWORK_ID }}"
          
          # Use the absolute path for the ZeroTier CLI
          $zt_cli = "C:\Program Files (x86)\ZeroTier\One\zerotier-one_x64.exe"
          & $zt_cli -q join $networkId
          
          Write-Host "ğŸ“¡ Join request sent for: $networkId"
          Write-Host "ğŸ‘‰ ACTION REQUIRED: Go to https://my.zerotier.com/ and AUTHORIZE this device."

      - name: ğŸ–¥ï¸ Configure Remote Desktop (RDP)
        shell: pwsh
        run: |
          Write-Host "ğŸ”“ Enabling RDP and Firewall rules..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
          Write-Host "âœ… RDP is now listening."

      - name: â³ Maintenance Loop (Keep Alive)
        shell: pwsh
        run: |
          Write-Host "==============================================="
          Write-Host "ğŸš€ DEPLOYMENT SUCCESSFUL"
          Write-Host "ğŸ‘¤ User: runneradmin"
          Write-Host "ğŸ”‘ Pass: EnigMano2026!"
          Write-Host "==============================================="
          
          # Keeping the session alive for the maximum duration
          for ($i=1; $i -le 360; $i++) {
            $time = Get-Date -Format "HH:mm:ss"
            Write-Host "[$time] Instance Active - Heartbeat $i/360"
            Start-Sleep -Seconds 60
          }
