name: "‚ö° EnigMano ZeroTier ARM Deployment"

on:
  workflow_dispatch:
    inputs:
      ZEROTIER_NETWORK_ID:
        description: "Your 16-digit ZeroTier Network ID"
        required: true

jobs:
  deploy-arm-rdp:
    name: "üöÄ Deploy ARM RDP via ZeroTier"
    runs-on: windows-11-arm
    timeout-minutes: 360

    steps:
      - name: üîê Configure Local Credentials
        shell: pwsh
        run: |
          $User = "runneradmin"
          $Pass = "EnigMano2026!"
          if (Get-LocalUser -Name $User -ErrorAction SilentlyContinue) {
            Set-LocalUser -Name $User -Password (ConvertTo-SecureString $Pass -AsPlainText -Force)
          } else {
            New-LocalUser -Name $User -Password (ConvertTo-SecureString $Pass -AsPlainText -Force) -FullName "Runner Admin"
          }
          if (-not (Get-LocalGroupMember -Group "Administrators" -Member $User -ErrorAction SilentlyContinue)) {
            Add-LocalGroupMember -Group "Administrators" -Member $User
          }

      - name: üèóÔ∏è Install ZeroTier
        shell: pwsh
        run: |
          $url = "https://download.zerotier.com/dist/ZeroTier%20One.msi"
          $outpath = "$env:TEMP\ZeroTier.msi"
          Write-Host "üì• Downloading MSI..."
          Invoke-WebRequest -Uri $url -OutFile $outpath
          Write-Host "‚öôÔ∏è Installing ZeroTier..."
          Start-Process msiexec.exe -ArgumentList "/i `"$outpath`" /quiet /qn" -Wait
          # Essential sleep for the service to initialize on ARM
          Start-Sleep -Seconds 30

      - name: üåê Connect to Virtual Network
        shell: pwsh
        run: |
          $networkId = "${{ github.event.inputs.ZEROTIER_NETWORK_ID }}"
          
          # This list covers every possible install location for ZeroTier on x64 and ARM
          $possiblePaths = @(
            "C:\Program Files\ZeroTier\One\zerotier-cli.exe",
            "C:\Program Files (x86)\ZeroTier\One\zerotier-cli.exe",
            "C:\ProgramData\ZeroTier\One\zerotier-one.exe",
            "$env:ProgramFiles\ZeroTier\One\zerotier-one.exe"
          )
          
          $zt_bin = $possiblePaths | Where-Object { Test-Path $_ } | Select-Object -First 1

          if ($zt_bin) {
            Write-Host "‚úÖ Found ZeroTier at: $zt_bin"
            # Attempt join using the found binary
            if ($zt_bin -like "*zerotier-one.exe*") {
                & $zt_bin -q join $networkId
            } else {
                & $zt_bin join $networkId
            }
            Write-Host "üì° Network join request sent."
          } else {
            Write-Error "‚ùå Fatal: Could not locate ZeroTier binaries after installation."
            exit 1
          }

      - name: üñ•Ô∏è Configure Remote Desktop (RDP)
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

      - name: ‚è≥ Maintenance Loop
        shell: pwsh
        run: |
          Write-Host "üöÄ Instance is LIVE. Authorize the member in your ZeroTier dashboard!"
          while($true) {
            Write-Host "Heartbeat: $(Get-Date)"
            Start-Sleep -Seconds 60
          }
