- name: üèóÔ∏è Install ZeroTier
        shell: pwsh
        run: |
          $url = "https://download.zerotier.com/dist/ZeroTier%20One.msi"
          $outpath = "$env:TEMP\ZeroTier.msi"
          $logpath = "$env:TEMP\zt_install.log"
          
          Write-Host "üì• Downloading ZeroTier..."
          Invoke-WebRequest -Uri $url -OutFile $outpath
          
          Write-Host "‚öôÔ∏è Installing ZeroTier (Logging to $logpath)..."
          # Added logging (/L*V) to help diagnose if the install fails
          $process = Start-Process msiexec.exe -ArgumentList "/i `"$outpath`" /quiet /qn /L*V `"$logpath`"" -Wait -PassThru
          
          if ($process.ExitCode -ne 0) {
              Write-Host "‚ùå Installation failed. Content of log:"
              Get-Content $logpath -Tail 20
              exit 1
          }
          Start-Sleep -Seconds 15

      - name: üåê Connect to Virtual Network
        shell: pwsh
        run: |
          $networkId = "${{ github.event.inputs.ZEROTIER_NETWORK_ID }}"
          
          # Refresh environment variables so the runner sees the new installation path
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

          # Try to find the CLI tool quickly using 'where' or standard paths
          $zt_cli = where.exe zerotier-cli 2>$null | Select-Object -First 1
          if (-not $zt_cli) {
              $paths = @(
                  "${env:ProgramFiles}\ZeroTier\One\zerotier-cli.exe",
                  "${env:ProgramFiles(x86)}\ZeroTier\One\zerotier-cli.exe",
                  "C:\ProgramData\ZeroTier\One\zerotier-one.exe"
              )
              $zt_cli = $paths | Where-Object { Test-Path $_ } | Select-Object -First 1
          }

          if ($zt_cli) {
              Write-Host "‚úÖ Found ZeroTier at: $zt_cli"
              & $zt_cli join $networkId
              
              # Wait for the service to actually get an IP
              Write-Host "‚è≥ Waiting for network assignment..."
              Start-Sleep -Seconds 10
              & $zt_cli listnetworks
          } else {
              Write-Error "‚ùå ZeroTier CLI not found. The MSI may have failed to extract files on this ARM runner."
              exit 1
          }
